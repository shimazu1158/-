import streamlit as st
import pandas as pd
import os
from datetime import datetime

# ä¿å­˜å…ˆã®CSVãƒ•ã‚¡ã‚¤ãƒ«å
DATA_PATH = "CRC-V_suihan_data.csv"

# é …ç›®åï¼ˆåˆ—åï¼‰
COLUMNS = [
    "è¨˜éŒ²æ—¥æ™‚", "ãƒ†ã‚¹ãƒˆNo",
    "ã‚·ãƒ£ãƒƒã‚¿ãƒ¼_é–‹æ™‚é–“ï¼ˆç§’ï¼‰", "ã‚·ãƒ£ãƒƒã‚¿ãƒ¼_é«˜ã•ï¼ˆmmï¼‰", "ã‚·ãƒ£ãƒƒã‚¿ãƒ¼_èƒ½åŠ›ï¼ˆkg/hï¼‰",
    "ã‚³ãƒ³ãƒ™ã‚¢_é€Ÿåº¦ï¼ˆç§’", "äº‹å‰æ´—ç±³_ãƒã‚ºãƒ«ç•ªæ‰‹", 
    "äº‹å‰æ´—ç±³_ãƒã‚ºãƒ«æ•°é‡", "äº‹å‰æ´—ç±³_ã»ãã—æ©Ÿ1", "äº‹å‰æ´—ç±³_ã»ãã—æ©Ÿ2", "äº‹å‰æ´—ç±³_æ´—ç±³æ°´åœ§åŠ›", "äº‹å‰æ´—ç±³_æ´—ç±³æ°´æµé‡ï¼ˆL/minï¼‰",
    "åŠ æ°´1_ãƒã‚ºãƒ«ç•ªæ‰‹", "åŠ æ°´1_æ°´åœ§ï¼ˆMPaï¼‰", "åŠ æ°´1_ãƒã‚ºãƒ«æ•°é‡","åŠ æ°´1_ã»ãã—æ©Ÿ",
    "åŠ æ°´2_ãƒã‚ºãƒ«ç•ªæ‰‹", "åŠ æ°´2_æ°´åœ§ï¼ˆMPaï¼‰", "åŠ æ°´2_ãƒã‚ºãƒ«æ•°é‡","åŠ æ°´2_ã»ãã—æ©Ÿ",
    "åŠ æ°´3_ãƒã‚ºãƒ«ç•ªæ‰‹", "åŠ æ°´3_æ°´åœ§ï¼ˆMPaï¼‰", "åŠ æ°´3_ãƒã‚ºãƒ«æ•°é‡","åŠ æ°´3_ã»ãã—æ©Ÿ",
    "åŠ æ°´æ¸©åº¦ (â„ƒ)","åŠ æ°´æµé‡ (L/min)","åŠ æ°´På‘¨æ³¢æ•° (Hz)",
    "æ´—æµ„æ°´På‘¨æ³¢æ•°ï¼ˆHzï¼‰", "å¾ªç’°åœ§åŠ›ï¼ˆMPaï¼‰", "è’¸æ°—å®¤æ¸©åº¦ï¼ˆâ„ƒï¼‰", "éç†±è’¸æ°—æ¸©åº¦ï¼ˆâ„ƒï¼‰",
    "å‡ºå£ã»ãã—æ©Ÿ", "ã»ãã—æ©Ÿå›è»¢ï¼ˆHzï¼‰",
    "ã»ãã—æ©Ÿ1", "ã»ãã—æ©Ÿ2", "ã»ãã—æ©Ÿï¼ˆHzï¼‰",
    "å‘¨æ³¢æ•°", "ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯", "æƒ³å®šå™´éœ§é‡", "ãƒã‚ºãƒ«ç•ªæ‰‹", "ãƒã‚ºãƒ«æ•°é‡",
    "ã“ã‚å“ç¨®", "ç”Ÿç±³å‡¦ç†é‡", "é…¢åˆã‚ã›å¾Œé‡é‡",
    "æ­©ç•™ã¾ã‚Š", "ç”Ÿç±³æ°´åˆ†ç‡", "äº‹å‰æ´—ç±³å¾Œæ°´åˆ†ç‡", "ç‚Šãã‚ãŒã‚Šæ°´åˆ†ç‡",
    "è’¸ã—æ©Ÿãƒãƒ¼ãƒŠãƒ¼çŠ¶æ…‹", "å‚™è€ƒ"
]

st.set_page_config(page_title="CRC-Vç‚Šé£¯ãƒ‡ãƒ¼ã‚¿ç™»éŒ²", layout="wide")
st.title("ğŸš ç‚Šé£¯ãƒ‡ãƒ¼ã‚¿ç™»éŒ²")

# å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
col1, col2, col3, col4 = st.columns(4)

with col1:
    st.markdown("### ç‚Šé£¯æ©Ÿ")
    test_no = st.text_input("ãƒ†ã‚¹ãƒˆNo")
    shutter_duration = st.number_input("ã‚·ãƒ£ãƒƒã‚¿ãƒ¼_é–‹æ™‚é–“ï¼ˆç§’ï¼‰", value=0)
    shutter_height = st.number_input("ã‚·ãƒ£ãƒƒã‚¿ãƒ¼_é«˜ã•ï¼ˆmmï¼‰", value=0)
    shutter_power = st.number_input("ã‚·ãƒ£ãƒƒã‚¿ãƒ¼_èƒ½åŠ›ï¼ˆkg/hï¼‰", value=0.0, format="%.1f")
    convey_speed = st.number_input("ã‚³ãƒ³ãƒ™ã‚¢_é€Ÿåº¦ï¼ˆç§’ï¼‰", value=0)
    add0_temp = st.text_input("äº‹å‰æ´—ç±³_ãƒã‚ºãƒ«ç•ªæ‰‹")
    add0_flow = st.text_input("äº‹å‰æ´—ç±³_ãƒã‚ºãƒ«æ•°é‡")
    add0_freq1 = st.text_input("äº‹å‰æ´—ç±³_ã»ãã—æ©Ÿ1")
    add0_freq2 = st.text_input("äº‹å‰æ´—ç±³_ã»ãã—æ©Ÿ2")
    add0_waterpressure = st.number_input("äº‹å‰æ´—ç±³_æ´—ç±³æ°´åœ§åŠ›", value=0.0, format="%.2f")
    add0_waterflow = st.number_input("äº‹å‰æ´—ç±³_æ´—ç±³æ°´æµé‡ï¼ˆL/minï¼‰", value=0.0, format="%.1f")
    add1_temp = st.text_input("åŠ æ°´1_ãƒã‚ºãƒ«ç•ªæ‰‹")
    add1_flow = st.number_input("åŠ æ°´1_æ°´åœ§ï¼ˆMPaï¼‰",value=0.0, format="%.2f")
    add1_freq1 = st.text_input("åŠ æ°´1_ãƒã‚ºãƒ«æ•°é‡")
    add1_freq2 = st.text_input("åŠ æ°´1_ã»ãã—æ©Ÿ")

with col2:
    st.markdown("### &nbsp;")
    add2_temp = st.text_input("åŠ æ°´2_ãƒã‚ºãƒ«ç•ªæ‰‹")
    add2_flow = st.number_input("åŠ æ°´2_æ°´åœ§ï¼ˆMPaï¼‰", value=0.0, format="%.2f")
    add2_freq1 = st.text_input("åŠ æ°´2_ãƒã‚ºãƒ«æ•°é‡")
    add2_freq2 = st.text_input("åŠ æ°´2_ã»ãã—æ©Ÿ")
    add3_temp = st.text_input("åŠ æ°´3_ãƒã‚ºãƒ«ç•ªæ‰‹")
    add3_flow = st.number_input("åŠ æ°´3_æ°´åœ§ï¼ˆMPaï¼‰", value=0.0, format="%.2f")
    add3_freq1 = st.text_input("åŠ æ°´3_ãƒã‚ºãƒ«æ•°é‡")
    add3_freq2 = st.text_input("åŠ æ°´3_ã»ãã—æ©Ÿ")
    add_temp = st.number_input("åŠ æ°´æ¸©åº¦ (â„ƒ)", value=0.0, format="%.1f")
    add_flow = st.number_input("åŠ æ°´æµé‡ (L/min)", value=0)
    add_freq = st.number_input("åŠ æ°´På‘¨æ³¢æ•° (Hz)", value=0)
    rinse_freq = st.number_input("æ´—æµ„æ°´På‘¨æ³¢æ•°ï¼ˆHzï¼‰", value=0)
    pressure = st.number_input("å¾ªç’°åœ§åŠ›ï¼ˆMPaï¼‰", value=0.0, format="%.3f")
    steam_temp = st.number_input("è’¸æ°—å®¤æ¸©åº¦ï¼ˆâ„ƒï¼‰", value=0.0, format="%.1f")
    supersteam_temp = st.number_input("éç†±è’¸æ°—æ¸©åº¦ï¼ˆâ„ƒï¼‰", value=0.0, format="%.1f")
    degate = st.text_input("å‡ºå£ã»ãã—æ©Ÿ")
    rotation = st.number_input("ã»ãã—æ©Ÿå›è»¢ï¼ˆHzï¼‰", value=0)

with col3:
    st.markdown("### èª¿å‘³ã‚³ãƒ³ãƒ™ã‚¢")
    addseasoning1 = st.text_input("ã»ãã—æ©Ÿ1")
    addseasoning2 = st.text_input("ã»ãã—æ©Ÿ2")
    addseasoning_rotation = st.number_input("ã»ãã—æ©Ÿï¼ˆHzï¼‰", value=0)
    seasoning_freq = st.text_input("å‘¨æ³¢æ•°", value="50â†’65â†’70")
    seasoning_stroke = st.number_input("ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯", value=0)
    seasoning_spraying = st.text_input("æƒ³å®šå™´éœ§é‡", value="100â†’130â†’150")
    seasoning_temp = st.text_input("ãƒã‚ºãƒ«ç•ªæ‰‹")
    seasoning_number = st.text_input("ãƒã‚ºãƒ«æ•°é‡")

with col4:
    st.markdown("### ç±³é–¢ä¿‚")
    rice_type = st.text_input("ã“ã‚å“ç¨®")
    raw_weight = st.number_input("ç”Ÿç±³å‡¦ç†é‡", value=0)
    mixed_weight = st.number_input("é…¢åˆã‚ã›å¾Œé‡é‡", value=0.0, format="%.2f")
    if raw_weight > 0:
        yield_rate = round((mixed_weight / raw_weight) * 100, 2)
    else:
        yield_rate = 0.0
    st.number_input("æ­©ç•™ã¾ã‚Šï¼ˆ%ï¼‰", value=yield_rate, format="%.1f", disabled=True)
    raw_moisture = st.number_input("ç”Ÿç±³æ°´åˆ†ç‡", value=0.0, format="%.1f")
    prewash_moisture = st.number_input("äº‹å‰æ´—ç±³å¾Œæ°´åˆ†ç‡", value=0.0, format="%.2f")
    cooked_moisture = st.number_input("ç‚Šãã‚ãŒã‚Šæ°´åˆ†ç‡", value=0.0, format="%.2f")
    burner_state = st.text_input("è’¸ã—æ©Ÿãƒãƒ¼ãƒŠãƒ¼çŠ¶æ…‹")

# ğŸ”» å‚™è€ƒæ¬„ï¼ˆèª¿å‘³ã‚³ãƒ³ãƒ™ã‚¢ã¨ç±³é–¢ä¿‚ã®ä¸‹ï¼‰
with st.container():
    st.markdown("### å‚™è€ƒ")
    remarks = st.text_area("", height=200)

# ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã ã‘ä¿å­˜å‡¦ç†
if st.button("ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ä¿å­˜"):
    required_fields = [test_no, rice_type, burner_state]
    if any(field.strip() == "" for field in required_fields):
        st.warning("ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›é …ç›®ãŒã™ã¹ã¦å…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
    else:
        new_data = [[
            datetime.now().strftime("%Y-%m-%d %H:%M:%S"), test_no,
            shutter_duration, shutter_height, shutter_power,
            convey_speed, add0_temp, add0_flow, add0_freq1, add0_freq2, add0_waterpressure, add0_waterflow,
            add1_temp, add1_flow, add1_freq1, add1_freq2,
            add2_temp, add2_flow, add2_freq1, add2_freq2,
            add3_temp, add3_flow, add3_freq1, add3_freq2,
            add_temp, add_flow, add_freq,
            rinse_freq, pressure, steam_temp, supersteam_temp,
            degate, rotation, 
            addseasoning1, addseasoning2, addseasoning_rotation,
            seasoning_freq, seasoning_stroke, seasoning_spraying, seasoning_temp, seasoning_number,
            rice_type, raw_weight, mixed_weight,
            yield_rate, raw_moisture, prewash_moisture, cooked_moisture,
            burner_state, remarks
        ]]

        new_df = pd.DataFrame(new_data, columns=COLUMNS)

        if os.path.exists(DATA_PATH):
            existing = pd.read_csv(DATA_PATH, encoding="utf-8-sig")
            combined = pd.concat([existing, new_df], ignore_index=True)
        else:
            combined = new_df

        combined.to_csv(DATA_PATH, index=False, encoding="utf-8-sig")
        st.success("ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼")

# ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤º
if os.path.exists(DATA_PATH):
    st.subheader("ğŸ“‹ ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ï¼ˆæœ€æ–°10ä»¶ï¼‰")
    df = pd.read_csv(DATA_PATH, encoding="utf-8-sig")
    st.dataframe(df.tail(10), use_container_width=True)
